# shtRipper

Код для извлечения данных из .sht файлов. На текущий момент файлы версии ниже 2 не поддерживаются, что будет исправлено
 при необходимости.

## feedback

Пожелания и камни в огород автора прошу публично направлять в секцию issues.
Разработка ведётся в основном на Linux, сообщайте о любых, в том числе специфичных для Windows, ошибках.

## install

Для использования достаточно поместить файл ripper.py в дерево Вашего проекта и импортировать его.

## dependency

Обязательные модули:
- _struct_
- _re_ 

являются стандартными, не требующими дополнительных действий со стороны пользователя.

Остальные модули импортируются при использовании соответствующих дополнительных функций:
- _matplotlib_ используется функцией _plot_hist(hist)_ для отрисовки графика сигнала.
- _urllib_ и _pysmb_ используются при вызове функции _extract(path, shotn, requested)_ с параметром 'path',
 не являющимся строкой ненулевой длины.

## usage

Примеры базового использования приведены в файле example.py

Необходимо импортирование файла:

    import ripper

---   
Команда на чтение и распаковку файла:
    
    data, table = ripper.extract_sht(path, shotn, request)
    
- _data_ - словарь, в котором ключами являются номера сигналов в файле, а значениями - словарь следующей структуры:
  - type - int, хранящее тип структуры данных.
  - name - str, содержит имя сигнала. Указано в _Combiscope_ в заголовке графика до ";".
  - comm - str, комментарий к сигналу, содержит номер и канал ацп, номер разряда. Указано в _Combiscope_ в заголовке 
  графика после ";".
  - unit - str, подпись оси ординат.
  - time - dict, содержит время создания .sht.
    - year - int, год.
    - month - int, номер месяца от 1 до 12.
    - weekDay - int, день недели (0 = вс, 1 = пн, ... 6 = сб).
    - monthDay - int, день месяца.
    - hour - int, час.
    - minute - int, минута.
    - second - int, секунда.
    - mSecond - int, миллисекунда.
  - \#ch - int, содержит число каналов в сигнале, необходимо для разархивирования.
  - tMin - float, минимум по шкале времени.
  - tMax - float, максимум по шкале времени.
  - uMin - float, описывает смещение данных по шкале ординат.
  - delta - float, описывает амплитуду сигнала.
  - data - list, содержит в себе сигнал. В зависимости от _type_ может содержать только ординаты,
   пары XY или тройки XYErr.
- _path_ - str, путь к файлу .sht (относительный или абсолютный).
- _shotn_ - int, номер разряда.
- _request_ - list, (опционально) передаётся список номеров сигналов для разархивирования. Без третьего аргумента
 производится полная, долгая разархивация всех обнаруженных сигналов.
- table - dict, содержит связь между элементами _request_ и ключами _data_.

 _path_ может иметь произвольный тип. В таком случае или если передана строка нулевой длины, производится попытка 
 получить запрошенный файл на сервере 172.16.12.127/Data/. Пример:
     
     data = ripper.extract_sht('', 38516)
     
_request_ может содержать как int номера запрашиваемых сигналов в файле, так и str регулярные выражения (Perl-like)
 для поиска в названиях сигналов. Так как одному выражению может соответствовать несколько сигналов, создаётся
  словарь _table_, ключами которого являются выражения из запроса, а значениями - list-ы с int номерами сигналов. 
  В режиме поиска по именам нет возможности верно оценить общее число сигналов для распаковки, поэтому счётчик в консоли
  учитывает только целочисленные выражения из _request_. 
  
  Ниже пример использования поиска по именам:
  
    data, link = ripper.extract_sht('', 38516, [1, '^i', 'аз'])
    
 При этом _data_ содержит сигналы с номерами [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 17, 84], 
 а _link_ = {'^i': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], 'аз': [17, 84]}. Запросу "^i" соответствуют те имена, в которых 
 "i" или "I" стоят на первом месте ("Ip новый", "Ics", ...), а "аз" соответствуют сигналы "Лазер" (17) и "Газонапуск" 
 (84). 
 Данная функция позволяет, например, получить все сигналы SXR, разбросанные по sht файлу.
 ---
 
 Функция _x_y(hist)_ преобразует данные в вид двух массивов равной длины, описывающих абсциссу и ординату точек:
 
    x, y = ripper.x_y(data[0][17])
 
 Алгоритм конвертации можно найти в теле функции и использовать напрямую в Вашем проекте.
 
 ---
Для просмотра графика выбранного сигнала, можно использовать функцию _plot_hist(hist)_
    
    ripper.plot_hist(data[0][17])

#to-do list

- add error handling
- support old versions
- try to accelerate code using numpy
- attempt to connect to remote if file is absent
